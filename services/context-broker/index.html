<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.112.7"><meta name=generator content="Relearn 5.7.0+tip"><meta name=description content><title>Context Broker :: Diwise for Developers</title><link href=/services/context-broker/index.xml rel=alternate type=application/rss+xml title="Context Broker :: Diwise for Developers"><link href=/images/favicon.ico?1685965235 rel=icon type=image/x-icon><link href=/css/fontawesome-all.min.css?1685965235 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/css/fontawesome-all.min.css?1685965235 rel=stylesheet></noscript><link href=/css/featherlight.min.css?1685965235 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/css/featherlight.min.css?1685965235 rel=stylesheet></noscript><link href=/css/auto-complete.css?1685965235 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/css/auto-complete.css?1685965235 rel=stylesheet></noscript><link href=/css/perfect-scrollbar.min.css?1685965235 rel=stylesheet><link href=/css/nucleus.css?1685965235 rel=stylesheet><link href=/css/fonts.css?1685965235 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/css/fonts.css?1685965235 rel=stylesheet></noscript><link href=/css/theme.css?1685965235 rel=stylesheet><link href=/css/theme-my-custom-variant.css?1685965235 rel=stylesheet id=variant-style><link href=/css/ie.css?1685965235 rel=stylesheet><link href=/css/variant.css?1685965235 rel=stylesheet><link href=/css/print.css?1685965235 rel=stylesheet media=print><script src=/js/url.js?1685965235></script>
<script src=/js/variant.js?1685965235></script>
<script>window.index_js_url="/index.search.js";var root_url="/",baseUriFull,baseUri=root_url.replace(/\/$/,"");window.T_Copy_to_clipboard="Copy to clipboard",window.T_Copied_to_clipboard="Copied to clipboard!",window.T_Copy_link_to_clipboard="Copy link to clipboard",window.T_Link_copied_to_clipboard="Copied link to clipboard!",window.T_No_results_found="No results found for \"{0}\"",window.T_N_results_found="{1} results found for \"{0}\"",baseUriFull="https://diwise.github.io/",window.variants&&variants.init(["my-custom-variant"])</script><script src=/js/jquery.min.js?1685965235 defer></script></head><body class="mobile-support html" data-url=/services/context-broker/index.html><div id=body class=default-animation><div id=sidebar-overlay></div><div id=toc-overlay></div><nav id=topbar class=highlightable dir=ltr><div><div class=navigation><a class="nav nav-next" href=/services/iot-agent/index.html title="IoT Agent (&#129106;)"><i class="fas fa-chevron-right fa-fw"></i></a></div><div class=navigation><a class="nav nav-prev" href=/services/index.html title="Microservices (&#129104;)"><i class="fas fa-chevron-left fa-fw"></i></a></div><div id=breadcrumbs><span id=sidebar-toggle-span><a href=# id=sidebar-toggle title='Menu (CTRL+ALT+n)'><i class="fas fa-bars fa-fw"></i></a></span>
<span id=toc-menu title='Table of Contents (CTRL+ALT+t)'><i class="fas fa-list-alt fa-fw"></i></span><ol class=links itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/index.html><span itemprop=name>Diwise</span></a><meta itemprop=position content="1">></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/services/index.html><span itemprop=name>Microservices</span></a><meta itemprop=position content="2">></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>Context Broker</span><meta itemprop=position content="3"></li></ol></div><div class="default-animation progress"><div class=toc-wrapper dir=ltr><nav id=TableOfContents><ul><li><a href=#description>Description</a></li><li><a href=#architecture>Architecture</a><ul><li><a href=#diagrams>Diagrams</a></li><li><a href=#endpoints>Endpoints</a></li></ul></li><li><a href=#links>Links</a></li><li><a href=#run>Run</a><ul><li><a href=#configuration>Configuration</a></li></ul></li><li><a href=#operations>Operations</a><ul><li><a href=#observability-and-monitoring>Observability and Monitoring</a></li><li><a href=#run-book>Run Book</a></li></ul></li><li><a href=#faq>FAQ</a></li><li><a href=#license>License</a></li></ul></nav></div></div></div></nav><main id=body-inner class="highlightable default" tabindex=-1><div class=flex-block-wrapper><div id=head-tags><div class=tags><a class=tag-link href=/tags/cip/index.html>cip</a></div></div><article class=default><h1 id=context-broker>Context Broker</h1><h2 id=description>Description</h2><p>This service is a distribution broker that federates information from multiple underlying NGSI-LD Context Brokers and across domains. It is responsible for implementing selected parts of the NGSI-LD API and limit the exposure of underlying services.</p><h2 id=architecture>Architecture</h2><h3 id=diagrams>Diagrams</h3><div class="mermaid align-center">C4Container
System_Ext(producer, "Context Producer", "An agent that uses the NGSI-LD context provision&lt;br>and/or registration functionality to provide or announce the&lt;br>availability of its context information to an NGSI-LD Context Broker")
System_Ext(consumer, "Context Consumer", "An agent that uses the query and&lt;br>subscription functionality of NGSI-LD to&lt;br>retrieve context information")
System_Ext(keycloak, "Keycloak", "Open ID Connect compliant&lt;br>identity and access management")
Container_Boundary(c1, "Context Broker") {
Container(context-broker, "context-broker", $techn="Go", "You are here")
Container_Ext(notifier, "notifier", $techn="Go", "A service that handles notifications")
}
Container_Boundary(c2, "Federated Brokers") {
Container_Ext(brokerA, "Context Broker A", "An architectural component that implements all the NGSI-LD interfaces")
Container_Ext(brokerB, "Context Broker B", "An architectural component that implements all the NGSI-LD interfaces")
}
Rel(producer, context-broker, "creates, updates or deletes&lt;br>entities in", "https, NGSI-LD")
Rel(consumer, context-broker, "fetches entities&lt;br>from", "https, NGSI-LD")
Rel(context-broker, notifier, "sends notifi-&lt;br>cations via", "https")
UpdateRelStyle(producer, context-broker, $offsetX="30", $offsetY="-150")
UpdateRelStyle(consumer, context-broker, $offsetX="50", $offsetY="-150")
UpdateRelStyle(context-broker, notifier, $offsetX="-30", $offsetY="-50")
Rel(context-broker, keycloak, "validates auth tokens", "OIDC")
UpdateRelStyle(context-broker, keycloak, $offsetX="-130", $offsetY="-50")
Rel(context-broker, brokerA, "creates, retrieves, updates or&lt;br>deletes entities in", "https, NGSI-LD")
Rel(context-broker, brokerB, "creates, retrieves, updates or&lt;br>deletes entities in", "https, NGSI-LD")
UpdateRelStyle(context-broker, brokerA, $offsetX="-180", $offsetY="-40")
UpdateRelStyle(context-broker, brokerB, $offsetX="-20", $offsetY="-40")
Rel(notifier, consumer, "notifies registered consumers&lt;br>about entity changes", "https, NGSI-LD")
UpdateLayoutConfig($c4ShapeInRow="2", $c4BoundaryInRow="1")</div><p><strong>TODO:</strong> Add a diagram that explains the inner workings of the context broker.</p><h3 id=endpoints>Endpoints</h3><p>The context broker implements a subset of the NGSI-LD API. In this section we will document what specific endpoints have been implemented.</p><h4 id=ngsi-ld>NGSI-LD</h4><p>In conformance with the specification, all NGSI-LD endpoints are presented under the root <em>/ngsi-ld/v1</em>. This context broker supports the following operations:</p><table><thead><tr><th>Operation</th><th>Spec</th><th>Method</th><th>Endpoint</th></tr></thead><tbody><tr><td>Create Entity</td><td>6.4.3.1</td><td>POST</td><td>/entities</td></tr><tr><td>Retrieve Entity</td><td>6.5.3.1</td><td>GET</td><td>/entities/{entityId}</td></tr><tr><td>Merge Entity</td><td>6.5.3.4</td><td>PATCH</td><td>/entities/{entityId}</td></tr><tr><td>Update Entity Attributes</td><td>6.6.3.2</td><td>PATCH</td><td>/entities/{entityId}/attrs/</td></tr><tr><td>Retrieve Temporal Evolution of an Entity</td><td>6.19.3.1</td><td>GET</td><td>/temporal/entities/{entityId}</td></tr><tr><td>Delete Entity</td><td>6.5.3.2</td><td>DELETE</td><td>/entities/{entityId}</td></tr><tr><td>Serve @context</td><td>6.30.3.1</td><td>GET</td><td>/jsonldContexts/{contextId}</td></tr></tbody></table><h4 id=probes>Probes</h4><p>A health endpoint, that can be used by kubernetes probes for instance, is exposed on the default port under /health. A future release will move this endpoint to a separate control and monitoring port.</p><h2 id=links>Links</h2><table><thead><tr><th>Where</th><th>Address</th></tr></thead><tbody><tr><td>Git Hub</td><td><a href=https://github.com/diwise/context-broker>https://github.com/diwise/context-broker</a></td></tr><tr><td>NGSI-LD API</td><td><a href=https://www.etsi.org/deliver/etsi_gs/CIM/001_099/009/01.06.01_60/gs_CIM009v010601p.pdf>https://www.etsi.org/deliver/etsi_gs/CIM/001_099/009/01.06.01_60/gs_CIM009v010601p.pdf</a></td></tr></tbody></table><h2 id=run>Run</h2><p>Since the service is distributed as a container image, it can easily be started using docker or podman with the following command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker run --rm ghcr.io/diwise/context-broker:prod-f84899004e8d3c0b72fa1c4a0803c187f72f90f8
</span></span></code></pre></div><p>To be able to do anything useful though it is dependent on one or more other brokers to federate. See the section on configuration below or checkout the compose file under <a href=https://github.com/diwise/diwise/tree/main/deployments/docker>https://github.com/diwise/diwise/tree/main/deployments/docker</a> for more help on this.</p><h3 id=configuration>Configuration</h3><h4 id=environment-variables>Environment variables</h4><table><thead><tr><th>Name</th><th>Type</th><th>Default</th><th>Description</th></tr></thead><tbody><tr><td>CONTEXT_BROKER_CLIENT_DEBUG</td><td>boolean</td><td>false</td><td>More verbose output that can be used for debugging problems. Note that this does <em>NOT</em> control the logging level per se.</td></tr><tr><td>SERVICE_PORT</td><td>integer</td><td>8080</td><td>The port to accept incoming connections on</td></tr></tbody></table><h4 id=command-line-flags>Command line flags</h4><table><thead><tr><th>Flag</th><th>Type</th><th>Default</th><th>Description</th></tr></thead><tbody><tr><td>config</td><td>file path</td><td>/opt/diwise/config/default.yaml</td><td>Path to a configuration file containing federation information.</td></tr><tr><td>policies</td><td>file path</td><td>/opt/diwise/config/authz.rego</td><td>An authorization policy file.</td></tr></tbody></table><h4 id=configuration-files>Configuration files</h4><p>There are two main configuration files that control the behaviour of the context broker. The first one is the federation configuration for the broker. While other brokers implement the subscription API from NGSI-LD, we have chosen a static configuration model that increase the security and supports the configuration as code methodology.</p><p>The other configuration file is the policy file that contains the authorization policy as code. The default policy uses secure defaults by only allowing <em>GET</em> requests. See more about this file under the next section.</p><h4 id=security>Security</h4><p>Access to endpoints and individual access to tenants, endpoints and entity types can be configured using an Open Policy Agent policy written in rego. The default policy sets secure defaults by restricting access to only allow GET requests.</p><p>An example of how to customize the authorization can be found in the policy file used by default in our docker compose example. See <a href=https://github.com/diwise/diwise/blob/main/deployments/docker/configs/diwise/devmgmt-auth.rego>https://github.com/diwise/diwise/blob/main/deployments/docker/configs/diwise/devmgmt-auth.rego</a>.</p><h2 id=operations>Operations</h2><p>If N organizations deploy their own on premise installations of diwise, they will most likely end up with N (+1?) different configurations due to differences in their infrastructure, policies and regulations. Our services are however built to allow for a large amount of flexibility when it comes to integrating diwise in an organization.</p><h3 id=observability-and-monitoring>Observability and Monitoring</h3><p>Since diwise is based on a microservice architecture it is of upmost importance that we provide easy access to indicators that can help monitoring tools and human beings infer the internal state of our platform.</p><h4 id=logging>Logging</h4><p>All logging is sent to stdout in json format so that it can be filtered and redirected to your logging aggregator of choice. In compose, we have chosen to use fluentbit to be able to aggregate the logging output using <a href=https://grafana.com/oss/loki/>Loki</a>.</p><p>Our logging framework of choice at the moment is zerolog, but we plan to make a breaking change when the structured logging package slog becomes available in the golang standard library. We really like zerolog, but believe that moving to a standard like slog is a better choice in the long run.</p><h4 id=metrics>Metrics</h4><p>There are currently no application specific metrics emitted from the broker, but there will be. We promise.</p><h4 id=tracing>Tracing</h4><p>To be able to connect the dots between different services we have decided to use the open telemetry sdk to create tracing spans with the appropriate tracing baggage. These spans can then be sent to a collector endpoint in the <a href=https://github.com/open-telemetry/opentelemetry-specification/blob/main/specification/protocol/otlp.md>OTLP</a> format and aggregated in a tool such as <a href=https://grafana.com/oss/tempo/>Tempo</a>.</p><p>The following traces are created at the application level:</p><table><thead><tr><th>Span</th><th>Attributes</th><th>Created By</th><th>Description</th></tr></thead><tbody><tr><td>post</td><td><em>none</em></td><td>notifier</td><td>Spans the posting of a notification to a registered endpoint.</td></tr><tr><td>create-entity</td><td>ngsild-tenant</td><td>ngsild</td><td>Spans a create entity operation intitiated via the NGSI-LD api.</td></tr><tr><td>query-entities</td><td>ngsild-tenant</td><td>ngsild</td><td>Spans a query entities operation intitiated via the NGSI-LD api.</td></tr><tr><td>retrieve-entity</td><td>ngsild-tenant entity-id</td><td>ngsild</td><td>Spans a retrieve entity operation intitiated via the NGSI-LD api.</td></tr><tr><td>merge-entity</td><td>ngsild-tenant entity-id</td><td>ngsild</td><td>Spans a merge entity operation intitiated via the NGSI-LD api.</td></tr><tr><td>update-entity-attributes</td><td>ngsild-tenant entity-id</td><td>ngsild</td><td>Spans an update entity attributes operation intitiated via the NGSI-LD api.</td></tr><tr><td>delete-entity</td><td>ngsild-tenant entity-id</td><td>ngsild</td><td>Spans a delete entity operation intitiated via the NGSI-LD api.</td></tr><tr><td>retrieve-temporal-entity</td><td>ngsild-tenant entity-id</td><td>ngsild</td><td>Spans a &ldquo;retrieve temporal evolution of entity&rdquo; operation intitiated via the NGSI-LD api.</td></tr></tbody></table><p>The ngsild spans have corresponding subspans that are generated by the context broker client package.</p><h3 id=run-book>Run Book</h3><p>In this section we will list different failure modes for the service, how to detect them based on observability data and how to recover from them.</p><h2 id=faq>FAQ</h2><p>This section is supposed to list questions that get asked frequently by integrators and developers.</p><h2 id=license>License</h2><p>This document is licensed <a href=https://creativecommons.org/licenses/by/3.0/>CC-BY</a></p><footer class=footline></footer></article></div></main></div><aside id=sidebar class=default-animation dir=ltr><div id=header-wrapper class=default-animation><div id=header class=default-animation><img src=/images/diwise-logo.png></div><form action=/search.html method=get><div class="searchbox default-animation"><button type=submit title="Search (CTRL+ALT+f)"><i class="fas fa-search"></i></button>
<label class=a11y-only for=search-by>Search</label>
<input data-search-input id=search-by name=search-by class=search-by type=search placeholder=Search...>
<span data-search-clear><i class="fas fa-times"></i></span></div></form><script>var contentLangs=["en"]</script><script src=/js/auto-complete.js?1685965235 defer></script>
<script src=/js/lunr.min.js?1685965235 defer></script>
<script src=/js/lunr.stemmer.support.min.js?1685965235 defer></script>
<script src=/js/lunr.multi.min.js?1685965235 defer></script>
<script src=/js/lunr.en.min.js?1685965235 defer></script>
<script src=/js/search.js?1685965235 defer></script></div><div id=homelinks class=default-animation><ul><li><a class=padding href=/index.html><i class="fas fa-home"></i> Home</a></li></ul></div><div id=content-wrapper class=highlightable><ul class=topics><li data-nav-id=/intro/index.html class=dd-item><a href=/intro/index.html><i class='fas fa-info-circle'></i> Introduction</a><ul id=subsections-925e5bfbd01266c727d74ae1db5ab0c6><li data-nav-id=/intro/supported-sensor-types/index.html class=dd-item><a href=/intro/supported-sensor-types/index.html><i class='fas fa-microchip'></i> Supported sensor types</a></li><li data-nav-id=/intro/measurements/index.html class=dd-item><a href=/intro/measurements/index.html><i class='fas fa-ruler'></i> Measurements</a></li><li data-nav-id=/intro/environments/index.html class=dd-item><a href=/intro/environments/index.html><i class='fas fa-map'></i> Environments</a></li></ul></li><li data-nav-id=/architecture/index.html class="dd-item alwaysopen"><a href=/architecture/index.html><i class='far fa-compass'></i> Architecture</a><ul id=subsections-a81d732c785e3254a4a6686c290336fc><li data-nav-id=/architecture/overview/index.html class=dd-item><a href=/architecture/overview/index.html><i class='fas fa-satellite'></i> Overview</a></li><li data-nav-id=/architecture/cip/index.html class=dd-item><a href=/architecture/cip/index.html><i class='fas fa-city'></i> City Information Platform</a></li><li data-nav-id=/architecture/iot/index.html class=dd-item><a href=/architecture/iot/index.html><i class='fas fa-cubes'></i> IoT Platform</a></li></ul></li><li data-nav-id=/services/index.html class="dd-item parent"><a href=/services/index.html><i class='fas fa-cogs'></i> Microservices</a><ul id=subsections-057108a1c1a3662b9db6ab679412fa8f><li data-nav-id=/services/context-broker/index.html class="dd-item active"><a href=/services/context-broker/index.html><i class='fas fa-sitemap'></i> Context Broker</a></li><li data-nav-id=/services/iot-agent/index.html class=dd-item><a href=/services/iot-agent/index.html><i class='fas fa-satellite-dish'></i> IoT Agent</a></li><li data-nav-id=/services/iot-core/index.html class=dd-item><a href=/services/iot-core/index.html><i class='fas fa-arrows-alt'></i> IoT Core</a></li><li data-nav-id=/services/iot-device-mgmt-web/index.html class=dd-item><a href=/services/iot-device-mgmt-web/index.html><i class='fas fa-tablet-alt'></i> IoT Device Dashboard</a></li><li data-nav-id=/services/iot-device-mgmt/index.html class=dd-item><a href=/services/iot-device-mgmt/index.html><i class='fas fa-list'></i> IoT Device Management</a></li><li data-nav-id=/services/iot-events/index.html class=dd-item><a href=/services/iot-events/index.html><i class='fas fa-arrows-alt'></i> IoT Events</a></li><li data-nav-id=/services/iot-transform-fiware/index.html class=dd-item><a href=/services/iot-transform-fiware/index.html><i class='fas fa-random'></i> IoT Transform Fiware</a></li></ul></li><li data-nav-id=/getting-started/index.html class=dd-item><a href=/getting-started/index.html><i class='fas fa-list-ol'></i> Getting Started</a><ul id=subsections-c727fab97b4d77e5b28ce8c448fb9000><li data-nav-id=/getting-started/how-to/index.html class="dd-item alwaysopen"><a href=/getting-started/how-to/index.html><i class='fas fa-chalkboard-teacher'></i> How to</a><ul id=subsections-5b8613b9b40b304158cb159e3894274e><li data-nav-id=/getting-started/how-to/dev-environment/index.html class=dd-item><a href=/getting-started/how-to/dev-environment/index.html><i class='fas fa-laptop-code'></i> Set up development environment</a></li><li data-nav-id=/getting-started/how-to/add-device/index.html class=dd-item><a href=/getting-started/how-to/add-device/index.html><i class='fas fa-plus-square'></i> Add a device</a></li><li data-nav-id=/getting-started/how-to/contribute/index.html class="dd-item alwaysopen"><a href=/getting-started/how-to/contribute/index.html><i class='fas fa-people-carry'></i> Contribute</a><ul id=subsections-7aef710009368ec0313075cac519cb0f><li data-nav-id=/getting-started/how-to/submit-pr/index.html class=dd-item><a href=/getting-started/how-to/submit-pr/index.html><i class='fas fa-code-branch'></i> Submit a pull request</a></li><li data-nav-id=/getting-started/how-to/submit-issues/index.html class=dd-item><a href=/getting-started/how-to/submit-issues/index.html><i class='fas fa-exclamation-triangle'></i> Submit an issue</a></li></ul></li></ul></li></ul></li><li data-nav-id=/deployment/index.html class=dd-item><a href=/deployment/index.html><i class='fas fa-cloud'></i> Deployment</a></li><li data-nav-id=/contact/index.html class=dd-item><a href=/contact/index.html><i class='fas fa-at'></i> Get in touch</a></li></ul><div id=shortcuts><div class=nav-title>More</div><ul><li><a class=padding href=/tags/index.html><i class='fas fa-tags'></i> Tags</a></li></ul></div><div class="footermargin footerLangSwitch footerVariantSwitch footerVisitedLinks footerFooter showFooter"></div><hr class="default-animation footerLangSwitch footerVariantSwitch footerVisitedLinks footerFooter showFooter"><div id=prefooter class="footerLangSwitch footerVariantSwitch footerVisitedLinks"><ul><li id=select-language-container class=footerLangSwitch><div class="padding select-container"><i class="fas fa-language fa-fw"></i>
<span>&nbsp;</span><div class=select-style><label class=a11y-only for=select-language>Language</label>
<select id=select-language onchange="location=baseUri+this.value"></select></div><div class=select-clear></div></div></li><li id=select-variant-container class=footerVariantSwitch><div class="padding select-container"><i class="fas fa-paint-brush fa-fw"></i>
<span>&nbsp;</span><div class=select-style><label class=a11y-only for=select-variant>Theme</label>
<select id=select-variant onchange=window.variants&&variants.changeVariant(this.value)><option id=my-custom-variant value=my-custom-variant selected>My Custom Variant</option></select></div><div class=select-clear></div></div><script>window.variants&&variants.markSelectedVariant()</script></li><li class=footerVisitedLinks><button class=padding onclick=clearHistory()><i class="fas fa-history fa-fw"></i> Clear History</button></li></ul></div><div id=footer class="footerFooter showFooter"><p>Built with <a href=https://github.com/McShelby/hugo-theme-relearn title=love><i class="fas fa-heart"></i></a> by <a href=https://gohugo.io/>Hugo</a></p></div></div></aside><script src=/js/clipboard.min.js?1685965235 defer></script>
<script src=/js/perfect-scrollbar.min.js?1685965235 defer></script>
<script src=/js/featherlight.min.js?1685965235 defer></script>
<script src=/js/jquery.svg.pan.zoom.js?1685965235 defer></script>
<script src=/js/mermaid.min.js?1685965235 defer></script>
<script>window.themeUseMermaid=JSON.parse("{}")</script><script src=/js/theme.js?1685965235 defer></script></body></html>